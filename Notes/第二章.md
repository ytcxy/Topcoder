## Spring Boot实践，开发社区登录模块

### 发送邮件

- 导入jar包

- 配置properties

  

```properties
spring.mail.host=smtp.qq.com
spring.mail.username= username
spring.mail.password=  授权码
spring.mail.properties.mail.smtp.auth=true
spring.mail.properties.mail.smtp.starttls.enable=true
spring.mail.properties.mail.smtp.starttls.required=true
```

- 发送邮件的工具类。

```Java
@Component
public class MailClient {
    private static final Logger logger = LoggerFactory.getLogger(MailClient.class);
    @Autowired
    private JavaMailSender mailSender;

    @Value("${spring.mail.username}")
    private String from;

    public void sendMail(String to, String subject, String content){
        try{
            MimeMessage message = mailSender.createMimeMessage();

            MimeMessageHelper helper = new MimeMessageHelper(message);
            helper.setFrom(from);
            helper.setTo(to);
            helper.setSubject(subject);
            helper.setText(content, true);
            mailSender.send(helper.getMimeMessage());

        } catch (MessagingException e){
            logger.error("send mail error: " + e.getMessage());
        }
    }
}
```

- 测试邮件发送， 一个是文本，一个是带有 html的。 

  

```Java
@SpringBootTest
@ContextConfiguration(classes = DemoApplication.class)
@RunWith(SpringRunner.class)
public class MailTests {
    @Autowired
    private MailClient mailClient;

    @Autowired
    private TemplateEngine templateEngine;

    @Test
    public void testMailSender(){
        mailClient.sendMail("yutao862238585@gmail.com", "test", "I'm ytc"); // 直接发送文本邮件。
    }


    @Test
    public void testMailSendHtml(){
        Context context = new Context(); // 为了参数给thymeleaf，所以用这个。 
        context.setVariable("username", "ytc");
        String content = templateEngine.process("/mail/demo", context); // 自动注入了模板引擎。找到路径喝传入参数。
        mailClient.sendMail("yutao862238585@gmail.com", "HTML", content);
    }
}

```

### 开发注册功能

- 访问注册页面
  - 点击顶部区域内的链接，打开注册页面
- 提交注册数据
  - 通过表单提交数据
  - 服务端验证账号是否已存在，邮箱是否已注册
  - 服务端发送激活邮件
- 激活注册账号
  - 点击邮件中的链接，访问服务端的激活服务。

#### 根据 thymeleaf 语法， 修改index页面， 注册页面。 

#### 编写 Service 层 由控制层提交的用户注册数据， 然后交给 dao层。

```Java
public Map<String, Object> register(User user){
    Map<String, Object> map = new HashMap<>();
    if (user == null) {
        throw new IllegalArgumentException("参数不能为空");
    }
    if (StringUtils.isBlank(user.getUsername())){
        map.put("usernameMsg", "账号不能为空");
        return map;
    }

    if (StringUtils.isBlank(user.getPassword())){
        map.put("passwordMsg", "密码不能为空");
        return map;
    }
    if (StringUtils.isBlank(user.getEmail())){
        map.put("mailMsg", "邮箱不能为空");
        return map;
    }
    User u = userMapper.selectByName(user.getUsername());
    if (u != null){
        map.put("emailMsg", "该账号已存在");
        return map;
    }

    u = userMapper.selectByEmail(user.getEmail());
    if (u != null){
        map.put("emailMsg", "该邮箱已存在");
        return map;
    }
    // 这个时候就可以注册用户了。
    user.setSalt(CommunityUtil.generateUUID().substring(0,5));
    user.setPassword(CommunityUtil.md5(user.getPassword() + user.getSalt()));
    user.setType(0);
    user.setStatus(0);
    user.setActivationCode(CommunityUtil.generateUUID());
    user.setHeaderUrl(String.format("http://images.nowcoder.com/head/%dt.png",new Random().nextInt(1000)));
    user.setCreateTime(new Date());
    userMapper.insertUser(user);

    // 激活邮件
    Context context = new Context();
    context.setVariable("email", user.getEmail());
    // http://localhost:8080/activation/101/code

    String url = domain + "/activation/" + user.getId() + "/" + user.getActivationCode();
    // 这里的 user.getId() 可以用， 是因为mybatis里面配置的回写功能。 直接把 id 填上了，一个是 properties文件里面的， 一个是xml文件里面的。
    context.setVariable("url", url);
    String content = templateEngine.process("/mail/activation", context);
    mailClient.sendMail(user.getEmail(), "激活账号", content);

    return map;
}
```



#### 编写 Controller 层， 注册的地址。post 请求。

```Java
@PostMapping("/register")
public String register(Model model, User user){
    Map<String, Object> map = userService.register(user);
    if (map == null || map.isEmpty()){
        model.addAttribute("msg", "注册成功，我们已经向您的邮箱发送了一封邮件 ，请尽快激活。");
        model.addAttribute("target", "/index");
        return "/site/operate-result";
    } else {
        model.addAttribute("usernameMsg", map.get("usernameMsg"));
        model.addAttribute("passwordMsg", map.get("passwordMsg"));
        model.addAttribute("emailMsg", map.get("emailMsg"));
        return "/site/register";
    }
}
```

通过GET 请求，到达注册的页面， 填写了注册的信息，然后提交，这个时候会到 Controller 层。

Controller 层会调用 Service 层的服务， 然后返回一个值， 根据值判断是不是注册成功。

如果成功跳转到 `poerate-result.html` 页面。

否则跳回原页面，然后展示错误信息，重新填写。

Service 层的服务就是看用户填写的信息是不是合法的，如果合法，那么就注册，然后发送邮件。



#### 激活账号，也就是确认邮箱。

Controller 层

根据Service 层返回的结果来判断激活的状态。 

```java
// http://localhost:8080/activation/{id}/{code}
@GetMapping("/activation/{userId}/{code}")
public String activation(Model model, @PathVariable("userId") int userId, @PathVariable("code") String code){
    int result = userService.activation(userId, code);
    if (result == ACTIVATION_SUCCESS){
        model.addAttribute("msg","激活成功，您的账号已经可以正常使用了！");
        model.addAttribute("target", "/login");

    } else if (result == ACTIVATION_REPEAT){
        model.addAttribute("msg", "无效操作，该账号已经激活了！");
        model.addAttribute("target", "/index");
    } else {
        model.addAttribute("msg", "激活失败，您的激活码不正确!");
        model.addAttribute("target", "/index");
    }
    return "/site/operate-result";
}
```

 Service 层

```Java
public int activation(int userId, String code){
    User user = userMapper.selectById(userId);
    System.out.println(userId);
    System.out.println(user);
    if (user.getStatus() == 1){
        return ACTIVATION_REPEAT;
    } else if (user.getActivationCode().equals(code)){
        userMapper.updateStatus(userId, 1);
        return ACTIVATION_SUCCESS;
    } else {
        return ACTIVATION_FAILURE;
    }

}
```







